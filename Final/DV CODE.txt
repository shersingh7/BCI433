DCL-F STUDENTREP PRINTER       OFLIND(*IN01) ;

DCL-F STUDENTS21 KEYED USAGE(*INPUT) RENAME(STUDENTS21: STUDENTFILE)
 DCL-F STGRADES21 KEYED USAGE(*INPUT) RENAME(STGRADES21: GRADEFILE)
 DCL-F PROGRAM21 KEYED USAGE(*INPUT) RENAME(PROGRAM21: PROGRAMFILE)
DCL-S EndOfFile IND;
DCL-S TotalRecords PACKED(5:0);

DCL-DS STUDENTRECORD;
	StID	PACKED(3:0);
	PROGRAM CHAR(31);
	GPA 	PACKED(3:2);
	RISKCOUNT PACKED(1:0);
END-DS STUDENTRECORD;

EXSR PREPAREFILE;
WRITE REPORTNAME;
WRITE COLHDR;
WRITE PROGNAME;
EXSR GETROW;
WRITE DETAILS;

DOW NOT EndOfFile;
	IF *IN01 = *ON;
	WRITE REPORTNAME;
	WRITE COLHDR;
	WRITE PROGNAME;
		*IN01 = *OFF;
	ENDIF;
	
	IF GPA < 2;
		*IN50 = *ON;
		RISKCOUNT = RISKCOUNT + 1;
	ENDIF;

ENDDO;

EXSR WRAPUP;
WRITE TOTALS;
*INLR = *ON;
RETURN;


//SUBROUTINES
BEGSR PREPAREFILE;

EXEC SQL
	DECLARE STUDENTCURSOR CURSOR
	FOR 
	
	SELECT STUDENT#, TRIM(FNAME) || ' ' || LNAME AS FULLNAME,  SELECT DATEDIFF(BIRTHDATE)/8766.0 AS AgeYearsDecimal
    ,CONVERT(int,ROUND(DATEDIFF(hour,@dob,GETDATE())/8766.0,0)) AS AgeYearsIntRound
    ,DATEDIFF(hour,@dob,GETDATE())/8766 AS Age
			FROM BCI433LIB/STUDENTS21
			WHERE STUDENT# = :STID

	UNION ALL
	
	SELECT SGCOURSE, SGARDE
		FROM BCI433LIB/STGRADES21
			WHERE SGRID = :STDID

		
	UNION ALL
	
	SELECT PRDESCRP
		FROM BCI433LIB/PROGRAM21
			WHERE PRSTID = :STDID

		
	FOR READ ONLY;
	
	
EXEC SQL
	OPEN STUDENTCURSOR;
	
	IF(SQLCODE <> 0) OR (SQLWN0 = 'W');
		ENDOFFLIE = *ON;
	ENDIF;
	
ENDSR;


BEGSR GETROW;

EXEC SQLFETCH NEXT
FROM STUDENTCURSOR
INTO :STUDENTRECORD;

IF(SQLCODE <> 0) OR (SQLWN0 = 'W');
		ENDOFFLIE = *ON;
	ENDIF;
	
ENDSR;

BEGSR WRAPUP;
EXEC SQL
CLOSE STUDENTCURSOR;

IF(SQLCODE <> 0) OR (SQLWN0 = 'W');
		ENDOFFLIE = *ON;
	ENDIF;
	
	EXEC SQL
	
	SELECT COUNT(SGRADE) INTO: GPA
		FROM STGRADES21
		WHERE SGRID = :STDID;
		
	EXEC SQL	
	SELECT COUNT(*) INTO: TOTALRECRD
	FROM STUDENTCURSOR;
	
	EXEC SQL
	SELECT AVG(Age) INTO: AVERAGEAGE
	FROM STUDENTCURSOR;
	
	EXEC SQL
	SELECT COUNT(RISKCOUNT) INTO: TOTALRISK
	FROM STUDENTCURSOR;

ENDSR;
	
	
	

	